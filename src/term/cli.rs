pub const MAIN_MENU_STR_1: &str = r"  _______                               
 |       | .----. .--.--. .----. .-----.
 |.|   | | |   _| |  |  | |  __| |  _  |
 `-|.  |-' |__|   |_____| |____| |_____|
   |:  |                                
   |::.|                                
   `---'                                
";

pub const MAIN_MENU_STR_2: &str = r"                                      _..._         .-'''-.     
                                   .-'_..._''.     '   _    \   
                                 .' .'      '.\  /   /` '.   \  
                                / .'            .   |     \  '  
     .|   .-,.--.              . '              |   '      |  ' 
   .' |_  |  .-. |             | |              \    \     / /  
 .'     | | |  | |    _    _   | |               `.   ` ..' /   
'--.  .-' | |  | |   | '  / |  . '                  '-...-'`    
   |  |   | |  '-   .' | .' |   \ '.          .                 
   |  |   | |       /  | /  |    '. `._____.-'/                 
   |  '.' | |      |   `'.  |      `-.______ /                  
   |   /  |_|      '   .'|  '/              `                   
   `'-'             `-'  `--'                                   

";

pub const MAIN_MENU_STR_3: &str = r"         ,  . .,  ¬∞         ,. -  .,                 .-,             ,'¬¥¬®';'                 ,. - .,                , ¬∑. ,.-¬∑~¬∑.,   ‚Äò    
   ;'¬¥    ,   ., _';\'     ,' ,. -  .,  `' ¬∑,          ;  ';\          ,'   ';'\'          ,¬∑'¬¥ ,. - ,   ';\           /  ¬∑'¬¥,.-¬∑-.,   `,'‚Äö    
   \:¬¥¬®¬Ø:;'   `;::'\:'\    '; '¬∑~;:::::'`,   ';\      ';   ;:'\        ,'   ,'::'\     ,¬∑¬¥  .'¬¥\:::::;'   ;:'\ '       /  .'¬¥\:::::::'\   '\ ¬∞  
     \::::;   ,'::_'\;'     ;   ,':\::;:¬¥  .¬∑¬¥::\'    ';  ';::';      ,'   ,'::::;    /  ,'¬¥::::'\;:-/   ,' ::;  '  ,¬∑'  ,'::::\:;:-¬∑-:';  ';\‚Äö  
         ,'  ,'::;'  ‚Äò       ;  ¬∑'-¬∑'¬¥,.-¬∑'¬¥:::::::';   ';  ';::;     ,'   ,'::::;'   ,'   ;':::::;'¬¥ ';   /\::;' '   ;.   ';:::;¬¥       ,'  ,':'\‚Äö 
         ;  ;:::;  ¬∞     ;¬¥    ':,¬¥:::::::::::¬∑¬¥'    ';  ';::;    ,'   ,'::::;'    ;   ;:::::;   '\*'¬¥\::\'  ¬∞    ';   ;::;       ,'¬¥ .'¬¥\::';‚Äö
         ;  ;::;'  ‚Äò       ';  ,    `¬∑:;:-¬∑'¬¥          \   '¬∑:_,'¬¥.;   ;::::;‚Äò    ';   ';::::';    '\::'\/.'       ';   ':;:   ,.¬∑¬¥,.¬∑¬¥::::\;'¬∞
         ;  ;::;'‚Äö         ; ,':\'`:¬∑.,  ` ¬∑.,          \¬∑,   ,.¬∑¬¥:';  ';:::';      \    '¬∑:;:'_ ,. -¬∑'¬¥.¬∑¬¥\‚Äò      \¬∑,   `*¬¥,.¬∑'¬¥::::::;¬∑¬¥   
         ',.'\::;'‚Äö         \¬∑-;::\:::::'`:¬∑-.,';         \:\¬Ø\:::::\`*¬¥\::;  '     '\:` ¬∑  .,.  -¬∑:¬¥::::::\'      \\:¬Ø::\:::::::;:¬∑¬¥      
          \::\:;'‚Äö          \::\:;'` ¬∑:;:::::\::\'         `'\::\;:¬∑¬¥'\:::'\'   '       \:::::::\:::::::;:¬∑'¬¥'        `\:::::\;::¬∑'¬¥  ¬∞       
           \;:'      ‚Äò       '¬∑-¬∑'       `' ¬∑ -':::''                    `*¬¥¬∞            `¬∑ :;::\;::-¬∑¬¥                 ¬Ø                  
             ¬∞                                                        '                                               ‚Äò                  

";

pub const MAIN_MENU_STR_4: &str = r"   /\                            /\   /¬Ø¬Ø¬Ø¬Ø\                  /\ '                                 /\    '‚Äö           /¬Ø¬Ø¬Ø\ '         
 /    \__________'      /    \|   |:'\    \              /    \     '                         /    \     ¬∞      /         \‚Äö        
|                        \¬∞   |\         |:::|    |            |\      \‚Äö                           |\      \     '   /            '\¬∞      
|\____         _       \'  |:|        |::/    /|            |:|      |    /'\‚Äö             /¬Ø¬Ø¬Ø\|:|      |‚Äò      |        |\      \¬∞    
|:|::::::|\       \:|\     /|¬∞ |:|        |/    /::|            |/      /|  /    \          /     /|\ \/     /|‚Äò      |        |::\      \ '‚Äö 
|:|::::::|::\       \::\/:::|   \|            (:::'|           /      /::| |\      \      /     /::|::\__/::'|‚Äò      |\       '\:::\      \ '
 \|::::::|::::\       \:|:::|    |      |\      \:/'         /      /::::| |:|      '|   /     /::::|:::|::|:::'|‚Äö      |::\       '\::|      | 
   ¬Ø¬Ø¬Ø \:::::\       \:::/‚Äò   |      |::\      \'       /      /:::::/  |/      /|  |     |:::::/\::|::|:::/'  ‚Äö    |::::\       '\|      | 
           \::::|        |/'     |      |::::\      \'   /      /:::::/'  /      /::|'‚Äö |\     \::/ /¬Ø¬Ø¬Ø¬Ø¬Ø¬Ø¬Ø\¬∞    \:::::\            /| 
             \'/        /|‚Äò     /'     /|\::::|      '|‚Äò |      |:::::/  /      /::::|'‚Äö |::\     \/  /|\           \‚Äö     \:::::\____ /::| 
             |\       /::|'    |\    /::|  \/       /|‚Äò |\      \::/_/      (:::::/   |::::\___/::|::\         /|‚Äò      \::::|::::::|:::'| 
             |::\   /::::|'    |::\/::::|   |\    /::|  |::\______/|\    /|::/‚Äò     \::::|::::|::'|::::\     /::|‚Äò        \::|::::::|::/‚Äò '
             |:::'\/:::::/‚Äò    |:::|::::/   |::\/::::|  |:::|:::::::::|:|::\/::|/‚Äò         \::|::::|::/\:::::\ /::::|           \|::::::|/‚Äò   '
             \::::|::::/ '‚Äö    \::'|::/     |:::|::::/¬∞  \::|:::::::::|:|::|:::|‚Äò            \|::::|/    \::::|::::/              ¬Ø¬Ø¬Ø'      
               \::|::/ '‚Äö        '\|/        \::|::/       \|:::::::::|/\::|::/   ¬∞           ¬Ø¬Ø        \::|::/                ‚Äò           
                 \|/¬∞                        \|/¬∞          ¬Ø¬Ø¬Ø¬Ø¬Ø    \|/                              '\|/                             ‚Äò

";

use std::{
    any::{type_name, Any},
    io::{self, stdout, Error},
    rc::Rc,
    thread::sleep,
    time::Duration,
};

use clap::{Parser, Subcommand};
use crossterm::{
    event::{self, DisableMouseCapture, EnableMouseCapture, Event, KeyCode},
    execute, queue,
    terminal::{disable_raw_mode, enable_raw_mode, EnterAlternateScreen, LeaveAlternateScreen},
};
use owo_colors::OwoColorize;
use serde::{Deserialize, Serialize};
use tui::{
    backend::{Backend, CrosstermBackend},
    layout::{Alignment, Constraint, Direction, Layout, Rect},
    style::{Color, Modifier, Style},
    text::{Span, Spans, Text},
    widgets::{Block, BorderType, Borders, Paragraph, Tabs, Wrap},
    Frame, Terminal,
};

use crate::{delete_all_dirs_recursively, game::jugador::Jugador, input};

use super::{main_menu_state::{MainMenuOptions, MainMenuState}, options::handle_options};

#[derive(Parser, Debug)]
#[command(
    version = "v0.0.1",
    about = "Juego de truco para la terminal",
    long_about = "Queres jugar al truco, y parecer un hacker mientras lo haces?\nEntonces este es tu juego! üÉè\nTenes acceso a partidas rapidas, y a un modo campa√±a extenso con muchisimo contenido al estilo Nethack.\nPodras conquistar el pais antes de que los paraguayos dominen el pais?"
)]
pub struct Cli {
    #[command(subcommand)]
    mode: Commands,
    #[arg(short, long)]
    debug: bool,
}

#[derive(Subcommand, Debug)]
enum Commands {
    #[command(about = "Jugar modo campa√±a.")]
    Campaign {},
    #[command(about = "Jugar partido rapido")]
    FastMatch {
        #[arg(short, long, default_value = "2")]
        player_count: u8,
    },
    #[command(about = "Jugar modo multijugador.")]
    Multiplayer {},
    #[command(about = "Configurar parametros.")]
    Options {},
    #[command(about = "Test.")]
    Test {},
    #[command(about = "Eliminar todos los datos (PELIGROSO)")]
    Reset,
}

pub fn handle_cli(cli: Cli) -> Result<(), Error> {
    // setup terminal
    enable_raw_mode()?;
    let mut stdout = io::stdout();
    execute!(stdout, EnterAlternateScreen, EnableMouseCapture)?;
    let backend = CrosstermBackend::new(stdout);
    let mut terminal = Terminal::new(backend)?;

    let res = run_app(&mut terminal);

    match cli.mode {
        Commands::Campaign {} => {}
        Commands::FastMatch { player_count } => {}
        Commands::Multiplayer {} => {}
        Commands::Options {} => {
            handle_options();
        }
        Commands::Test {} => {}
        Commands::Reset => {
            println!("{}", "Reseteando datos".red().bold());
            delete_all_dirs_recursively().expect("Error al borrar directorios");
        }
    }

    // restore terminal
    disable_raw_mode()?;
    execute!(
        terminal.backend_mut(),
        LeaveAlternateScreen,
        DisableMouseCapture
    )?;
    terminal.show_cursor()?;

    if let Err(e) = res {
        println!("Error: {}", e);
    }

    Ok(())
}

fn run_app<B: Backend>(terminal: &mut Terminal<B>) -> io::Result<()> {
    // app main loop
    let mut menu_state = MainMenuState::new();
    loop {
        terminal.draw(|f| main_menu(f, &menu_state))?;

        if let Event::Key(key) = event::read()? {
            match key.code {
                KeyCode::Left => menu_state.previous(),
                KeyCode::Right => menu_state.next(),
                KeyCode::Char(c) => match c {
                    'e' => menu_state.next_tab(),
                    'q' => menu_state.previous_tab(),
                    _ => {}
                },
                KeyCode::Esc | KeyCode::Backspace => break Ok(()),
                _ => {}
            }
        }
    }
}

fn main_menu<B: Backend>(f: &mut Frame<B>, state: &MainMenuState) {
    // Tama√±o de la terminal
    let size = f.size();

    // Chunks iniciales, en si es la pantalla entera
    let chunks = Layout::default()
        .direction(Direction::Vertical)
        .margin(0)
        .constraints([Constraint::Length(3), Constraint::Percentage(100)].as_ref())
        .split(size);

    let tab_chunks = Layout::default()
        .direction(Direction::Horizontal)
        .constraints(
            [
                Constraint::Length(
                    state
                        .tabs_titles_iter()
                        .map(|&s| s.chars().count() as u16 + 4)
                        .sum::<u16>()
                        - 1,
                ),
                Constraint::Percentage(100),
            ]
            .as_ref(),
        )
        .split(chunks[0]);

    // Tabs
    let titles = state
        .tabs_titles_iter()
        .map(|&title| {
            Spans::from(Span::styled(
                title,
                Style::default()
                    .fg(Color::White)
                    .add_modifier(Modifier::BOLD),
            ))
        })
        .collect();

    let tabs = Tabs::new(titles)
        .block(
            Block::default()
                .borders(Borders::ALL)
                .border_type(BorderType::Rounded),
        )
        .select(state.tab_selected)
        .style(Style::default().fg(Color::White))
        .highlight_style(Style::default().fg(Color::Red).add_modifier(Modifier::BOLD))
        .divider(Span::raw("|"));

    f.render_widget(tabs, tab_chunks[0]);


    match state.tab_selected {
        0 => {render_main_menu(f, state, chunks[1])},
        1 => {},
        _ => {}
    }

    
}


fn render_main_menu<B: Backend>(f: &mut Frame<B>, state: &MainMenuState, chunk: Rect) {
    // Sub recuadros, uno para el ascii art y otro para las opciones
    let sub_chunks = Layout::default()
        .direction(Direction::Horizontal)
        .vertical_margin(4)
        .horizontal_margin(1)
        .constraints([Constraint::Percentage(50), Constraint::Percentage(50)].as_ref())
        .direction(Direction::Vertical)
        .split(chunk);
    
    // Recuadro principal
    let main_box = Block::default()
        .borders(Borders::ALL)
        .border_type(BorderType::Rounded)
        // .title("Main menu")
        .title_alignment(Alignment::Left);

    f.render_widget(main_box, chunk);
    // Ascii art
    let main_menu_ascii_art = Text::from(MAIN_MENU_STR_2);
    let main_menu_str_paragraph = Paragraph::new(main_menu_ascii_art)
        .style(Style::default().fg(Color::White))
        .alignment(Alignment::Center);

    f.render_widget(main_menu_str_paragraph, sub_chunks[0]);

    // Los chunks para las opciones...
    let item_chunk = Layout::default()
        .direction(Direction::Horizontal)
        .vertical_margin(7)
        .horizontal_margin(1)
        .constraints(
            &state
                .main_menu_options
                .iter()
                .map(|_| Constraint::Ratio(1, state.main_menu_options.len() as u32))
                .collect::<Vec<_>>()[..],
        )
        .split(sub_chunks[1]);

    // Las opciones en si
    let items = state
        .main_menu_options
        .iter()
        .enumerate()
        .map(|(i, &opt)| {
            let opt_str = match opt {
                MainMenuOptions::Campaign => "Campa√±a",
                MainMenuOptions::FastMatch => "Partida rapida",
                MainMenuOptions::Multiplayer => "Multijugador",
                MainMenuOptions::Options => "Opciones",
                MainMenuOptions::Test => "Test",
                MainMenuOptions::Reset => "Reset",
            };
            let style = if opt == state.selected_mm_option() {
                Style::default().fg(Color::Red).add_modifier(Modifier::BOLD)
            } else {
                Style::default().fg(Color::White)
            };
            Span::styled(opt_str, style)
        })
        .collect::<Vec<_>>();

    items.iter().enumerate().for_each(|(i, item)| {
        let paragraph = Paragraph::new(item.clone())
            .block(
                Block::default()
                    .borders(Borders::ALL)
                    .border_type({
                        if state.selected_mm_option() == state.main_menu_options[i] {
                            BorderType::Double
                        } else {
                            BorderType::Plain
                        }
                    })
                    .border_style({
                        if state.selected_mm_option() == state.main_menu_options[i] {
                            Style::default().fg(Color::Red)
                        } else {
                            Style::default().fg(Color::White)
                        }
                    }),
            )
            .style(Style::default().fg(Color::White))
            .alignment(Alignment::Center)
            .wrap(Wrap { trim: false });
        f.render_widget(paragraph, item_chunk[i]);
    });
}